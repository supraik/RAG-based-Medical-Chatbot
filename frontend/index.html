<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HaleAI Medical Chatbot - AI-powered medical information assistant">
    <title>HaleAI Medical Chatbot</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts for Analytics -->
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .animate-pulse-slow { animation: pulse 2s infinite; }
        
        /* Improve text wrapping */
        .message-content {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';

        // =====================================================================
        // ERROR BOUNDARY
        // =====================================================================
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('React Error:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center p-4">
                            <div className="max-w-md text-center">
                                <h1 className="text-2xl font-bold mb-4">‚ö†Ô∏è Something went wrong</h1>
                                <p className="text-gray-400 mb-6">{this.state.error?.message || 'An unexpected error occurred'}</p>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="px-6 py-3 bg-blue-600 rounded-lg hover:bg-blue-700 transition"
                                >
                                    Reload Page
                                </button>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // =====================================================================
        // ICONS
        // =====================================================================
        const Icons = {
            Send: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            ),
            Menu: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            ),
            X: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            ),
            Sun: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            ),
            Moon: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            ),
            Sparkles: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
            ),
            MessageSquare: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            ),
            BarChart3: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M3 3v18h18"></path>
                    <path d="M18 17V9"></path>
                    <path d="M13 17V5"></path>
                    <path d="M8 17v-3"></path>
                </svg>
            ),
            Settings: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m5.196-15.196l-4.242 4.242m0 5.656l-4.243 4.243M23 12h-6m-6 0H1m15.196 5.196l-4.242-4.242m0-5.656l-4.243-4.243"></path>
                </svg>
            ),
            Loader2: () => (
                <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                </svg>
            ),
            Download: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            ),
            Trash: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            ),
            Brain: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path>
                    <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path>
                </svg>
            ),
            Clock: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            ),
            Activity: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            ),
            Zap: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
            ),
        };

        // =====================================================================
        // API CLIENT
        // =====================================================================
        class HaleAIAPI {
            constructor() {
                this.baseURL = API_BASE_URL;
                this.sessionId = null;
                
                // Load session from localStorage
                const saved = localStorage.getItem('haleai_session');
                if (saved) {
                    this.sessionId = saved;
                }
            }

            async checkHealth() {
                try {
                    const response = await fetch(`${this.baseURL}/api/health`, {
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    return response.ok;
                } catch {
                    return false;
                }
            }

            async sendMessageStream(message, onToken, onComplete, onError) {
                try {
                    const response = await fetch(`${this.baseURL}/api/chat/stream`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message, 
                            session_id: this.sessionId 
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const reader = response.body?.getReader();
                    const decoder = new TextDecoder();

                    if (!reader) throw new Error('ReadableStream not supported');

                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        
                        // Keep the last incomplete line in buffer
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.type === 'token') {
                                        onToken(data.content);
                                    } else if (data.type === 'complete') {
                                        this.sessionId = data.session_id;
                                        localStorage.setItem('haleai_session', data.session_id);
                                        onComplete(data);
                                    } else if (data.type === 'error') {
                                        onError(data.content);
                                    }
                                } catch (e) {
                                    console.error('Failed to parse SSE data:', e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Stream error:', error);
                    onError(error.message || 'Connection failed. Is the backend running?');
                }
            }

            async getAnalytics() {
                const response = await fetch(`${this.baseURL}/api/analytics`);
                if (!response.ok) throw new Error('Failed to fetch analytics');
                return response.json();
            }

            async exportConversation(format = 'json') {
                if (!this.sessionId) throw new Error('No active session to export');
                const response = await fetch(
                    `${this.baseURL}/api/conversations/${this.sessionId}/export?format=${format}`
                );
                if (!response.ok) throw new Error('Failed to export conversation');
                return response.json();
            }
        }

        const api = new HaleAIAPI();

        // =====================================================================
        // SIMPLE MARKDOWN RENDERER
        // =====================================================================
        function renderMarkdown(text) {
            if (!text) return '';
            
            return text
                // Bold: **text** or __text__
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.+?)__/g, '<strong>$1</strong>')
                // Italic: *text* or _text_
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/_(.+?)_/g, '<em>$1</em>')
                // Code: `code`
                .replace(/`(.+?)`/g, '<code class="px-1 py-0.5 bg-gray-700 rounded text-sm">$1</code>')
                // Lists: - item or * item
                .replace(/^\s*[-*]\s+(.+)$/gm, '<li class="ml-4">$1</li>')
                // Headings: ### Heading
                .replace(/^###\s+(.+)$/gm, '<h3 class="font-bold text-lg mt-2 mb-1">$1</h3>')
                .replace(/^##\s+(.+)$/gm, '<h2 class="font-bold text-xl mt-2 mb-1">$1</h2>')
                .replace(/^#\s+(.+)$/gm, '<h1 class="font-bold text-2xl mt-2 mb-1">$1</h1>');
        }

        // =====================================================================
        // CHAT BUBBLE COMPONENT
        // =====================================================================
        function ChatBubble({ message, darkMode }) {
            const isUser = message.role === 'user';
            
            return (
                <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-4 animate-slideIn`}>
                    <div className={`max-w-[70%] rounded-2xl px-6 py-4 ${
                        isUser 
                            ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white ml-auto' 
                            : darkMode 
                                ? 'bg-gray-800/80 text-white border border-gray-700' 
                                : 'bg-gray-100 text-gray-900 border border-gray-200'
                    } backdrop-blur-sm shadow-lg`}>
                        <div 
                            className="text-sm leading-relaxed message-content"
                            dangerouslySetInnerHTML={{ __html: renderMarkdown(message.content) }}
                        />
                        <p className={`text-xs mt-2 ${isUser ? 'text-blue-100' : darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </p>
                    </div>
                </div>
            );
        }

        // =====================================================================
        // STAT CARD COMPONENT
        // =====================================================================
        function StatCard({ icon: Icon, title, value, trend, color, darkMode }) {
            return (
                <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur-sm border rounded-2xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-2xl group`}>
                    <div className="flex items-start justify-between">
                        <div>
                            <p className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>{title}</p>
                            <p className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{value}</p>
                            {trend && (
                                <p className="text-sm text-green-500 mt-2 flex items-center gap-1">
                                    <span>&#8599;</span>
                                    {trend}
                                </p>
                            )}
                        </div>
                        <div className={`p-3 rounded-xl ${color} bg-opacity-20 group-hover:scale-110 transition-transform duration-300`}>
                            <Icon />
                        </div>
                    </div>
                </div>
            );
        }

        // =====================================================================
        // MAIN APP COMPONENT
        // =====================================================================
        function HaleAIApp() {
            // State management
            const [darkMode, setDarkMode] = useState(true);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('chat');
            const [connectionStatus, setConnectionStatus] = useState('checking');
            const [messages, setMessages] = useState([
                { role: 'assistant', content: "Hello! I'm Dr. Hale, your AI medical assistant. How can I help you today?", timestamp: new Date() }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isStreaming, setIsStreaming] = useState(false);
            const [streamingMessage, setStreamingMessage] = useState('');
            const [sources, setSources] = useState([]);
            const [analytics, setAnalytics] = useState({
                accuracy: 94.2,
                avg_latency: 245,
                total_queries: 1247,
                active_users: 23
            });
            const [analyticsLoading, setAnalyticsLoading] = useState(true);
            
            const chatEndRef = useRef(null);

            // Auto-scroll to bottom
            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages, streamingMessage]);

            // Check backend connection
            useEffect(() => {
                const checkConnection = async () => {
                    const isHealthy = await api.checkHealth();
                    setConnectionStatus(isHealthy ? 'connected' : 'disconnected');
                };
                
                checkConnection();
                const interval = setInterval(checkConnection, 30000);
                return () => clearInterval(interval);
            }, []);

            // Load analytics
            useEffect(() => {
                const loadAnalytics = async () => {
                    try {
                        const data = await api.getAnalytics();
                        setAnalytics(data);
                    } catch (err) {
                        console.error('Failed to load analytics:', err);
                    } finally {
                        setAnalyticsLoading(false);
                    }
                };
                
                loadAnalytics();
                const interval = setInterval(loadAnalytics, 10000);
                return () => clearInterval(interval);
            }, []);

            // Load saved messages from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('haleai_messages');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const withDates = parsed.map(msg => ({
                            ...msg,
                            timestamp: new Date(msg.timestamp)
                        }));
                        setMessages(withDates);
                    } catch (e) {
                        console.error('Failed to load saved messages:', e);
                    }
                }
            }, []);

            // Save messages to localStorage
            useEffect(() => {
                if (messages.length > 1) {
                    localStorage.setItem('haleai_messages', JSON.stringify(messages));
                }
            }, [messages]);

            // Handle send message
            const handleSendMessage = async () => {
                const trimmedInput = input.trim();
                
                // Validation
                if (!trimmedInput) return;
                if (trimmedInput.length > 2000) {
                    alert('Message is too long. Please keep it under 2000 characters.');
                    return;
                }
                if (isLoading) return;

                const userMessage = { role: 'user', content: trimmedInput, timestamp: new Date() };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);
                setIsStreaming(true);
                setStreamingMessage('');

                let fullMessage = '';

                try {
                    await api.sendMessageStream(
                        trimmedInput,
                        (token) => {
                            fullMessage += token;
                            setStreamingMessage(fullMessage);
                        },
                        (data) => {
                            const assistantMessage = {
                                role: 'assistant',
                                content: fullMessage,
                                timestamp: new Date()
                            };
                            setMessages(prev => [...prev, assistantMessage]);
                            setSources(data.sources || []);
                            setStreamingMessage('');
                            setIsStreaming(false);
                            setIsLoading(false);
                        },
                        (error) => {
                            console.error('Stream error:', error);
                            const errorMessage = {
                                role: 'assistant',
                                content: `Sorry, I encountered an error: ${error}`,
                                timestamp: new Date()
                            };
                            setMessages(prev => [...prev, errorMessage]);
                            setIsStreaming(false);
                            setIsLoading(false);
                            setStreamingMessage('');
                        }
                    );
                } catch (error) {
                    console.error('Error:', error);
                    setIsLoading(false);
                    setIsStreaming(false);
                }
            };

            // Handle export
            const handleExport = async (format) => {
                try {
                    const data = await api.exportConversation(format);
                    const content = format === 'json' ? JSON.stringify(data, null, 2) : data.content;
                    const blob = new Blob([content], 
                        { type: format === 'json' ? 'application/json' : 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `haleai-conversation-${Date.now()}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error('Export failed:', err);
                    alert('Failed to export conversation. Make sure you have an active session.');
                }
            };

            // Clear chat
            const handleClearChat = () => {
                if (confirm('Clear all messages? This cannot be undone.')) {
                    setMessages([
                        { role: 'assistant', content: "Hello! I'm Dr. Hale, your AI medical assistant. How can I help you today?", timestamp: new Date() }
                    ]);
                    setSources([]);
                    localStorage.removeItem('haleai_messages');
                    localStorage.removeItem('haleai_session');
                    api.sessionId = null;
                }
            };

            return (
                <div className={`min-h-screen ${darkMode ? 'bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white' : 'bg-gradient-to-br from-gray-50 via-white to-gray-50 text-gray-900'} transition-colors duration-500`}>
                    {/* Connection Status Banner */}
                    {connectionStatus === 'disconnected' && (
                        <div className="fixed top-0 left-0 right-0 bg-red-600 text-white py-2 px-4 text-center z-50 text-sm">
                            ‚ö†Ô∏è Backend disconnected. Start server: <code className="bg-red-700 px-2 py-1 rounded">cd backend && python backend_api.py</code>
                        </div>
                    )}

                    {/* Header */}
                    <header className={`${darkMode ? 'bg-gray-900/50 border-gray-800' : 'bg-white/50 border-gray-200'} backdrop-blur-md border-b sticky ${connectionStatus === 'disconnected' ? 'top-10' : 'top-0'} z-40`}>
                        <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="lg:hidden">
                                    {sidebarOpen ? <Icons.X /> : <Icons.Menu />}
                                </button>
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center">
                                        <Icons.Sparkles />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold">HaleAI</h1>
                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Medical Intelligence</p>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className={`hidden md:flex items-center gap-2 px-4 py-2 rounded-full ${
                                    connectionStatus === 'connected' 
                                        ? 'bg-green-500/20 border-green-500/30' 
                                        : 'bg-red-500/20 border-red-500/30'
                                } border`}>
                                    <div className={`w-2 h-2 rounded-full ${
                                        connectionStatus === 'connected' ? 'bg-green-500' : 'bg-red-500'
                                    } animate-pulse-slow`}></div>
                                    <span className={`text-sm font-medium ${
                                        connectionStatus === 'connected' ? 'text-green-500' : 'text-red-500'
                                    }`}>
                                        {connectionStatus === 'connected' ? 'Online' : 'Offline'}
                                    </span>
                                </div>
                                <button
                                    onClick={() => setDarkMode(!darkMode)}
                                    className={`p-2 rounded-xl ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-100 hover:bg-gray-200'} transition-all duration-300`}
                                >
                                    {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="flex h-[calc(100vh-73px)]">
                        {/* Sidebar */}
                        <aside className={`${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 fixed lg:static w-64 h-full ${darkMode ? 'bg-gray-900/50 border-gray-800' : 'bg-white/50 border-gray-200'} backdrop-blur-md border-r transition-transform duration-300 z-30`}>
                            <nav className="p-4 space-y-2">
                                {[
                                    { id: 'chat', icon: Icons.MessageSquare, label: 'Chat' },
                                    { id: 'dashboard', icon: Icons.BarChart3, label: 'Analytics' },
                                    { id: 'settings', icon: Icons.Settings, label: 'Settings' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => { setActiveTab(tab.id); setSidebarOpen(false); }}
                                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 ${
                                            activeTab === tab.id
                                                ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg'
                                                : darkMode
                                                    ? 'hover:bg-gray-800 text-gray-400 hover:text-white'
                                                    : 'hover:bg-gray-100 text-gray-600 hover:text-gray-900'
                                        }`}
                                    >
                                        <tab.icon />
                                        <span className="font-medium">{tab.label}</span>
                                    </button>
                                ))}
                            </nav>
                        </aside>

                        {/* Main Area */}
                        <main className="flex-1 overflow-auto">
                            {activeTab === 'chat' && (
                                <div className="max-w-5xl mx-auto h-full flex flex-col p-6">
                                    {/* Chat Messages */}
                                    <div className="flex-1 overflow-y-auto mb-6 space-y-4">
                                        {messages.map((msg, i) => (
                                            <ChatBubble key={i} message={msg} darkMode={darkMode} />
                                        ))}
                                        
                                        {isStreaming && streamingMessage && (
                                            <ChatBubble message={{ role: 'assistant', content: streamingMessage, timestamp: new Date() }} darkMode={darkMode} />
                                        )}

                                        {isLoading && !streamingMessage && (
                                            <div className="flex gap-2 items-center">
                                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-gray-200'} rounded-2xl px-6 py-4`}>
                                                    <div className="flex gap-2">
                                                        <div className="w-2 h-2 rounded-full bg-blue-500 animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                        <div className="w-2 h-2 rounded-full bg-blue-500 animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                        <div className="w-2 h-2 rounded-full bg-blue-500 animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {sources.length > 0 && (
                                            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-4`}>
                                                <h4 className="font-semibold mb-2">üìö Sources ({sources.length})</h4>
                                                <div className="space-y-2">
                                                    {sources.map((src, i) => (
                                                        <div key={i} className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} p-2 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-gray-50'}`}>
                                                            <span className="font-medium">Page {src.page}:</span> {src.content}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        <div ref={chatEndRef} />
                                    </div>

                                    {/* Input Area */}
                                    <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur-sm border rounded-2xl p-4 shadow-2xl`}>
                                        <div className="flex gap-3 mb-3">
                                            <input
                                                type="text"
                                                value={input}
                                                onChange={(e) => setInput(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && handleSendMessage()}
                                                placeholder="Ask a medical question..."
                                                disabled={isLoading || connectionStatus !== 'connected'}
                                                className={`flex-1 px-4 py-3 rounded-xl ${darkMode ? 'bg-gray-900 text-white border-gray-700' : 'bg-gray-50 text-gray-900 border-gray-200'} border focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all disabled:opacity-50`}
                                            />
                                            <button
                                                onClick={handleSendMessage}
                                                disabled={!input.trim() || isLoading || connectionStatus !== 'connected'}
                                                className="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium hover:shadow-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 flex items-center gap-2"
                                            >
                                                {isLoading ? <Icons.Loader2 /> : <Icons.Send />}
                                            </button>
                                        </div>
                                        <div className="flex gap-2 flex-wrap">
                                            <button 
                                                onClick={() => handleExport('json')} 
                                                className="text-xs px-3 py-1 rounded-lg bg-gray-700 hover:bg-gray-600 flex items-center gap-1 transition"
                                            >
                                                <Icons.Download /> Export JSON
                                            </button>
                                            <button 
                                                onClick={() => handleExport('txt')} 
                                                className="text-xs px-3 py-1 rounded-lg bg-gray-700 hover:bg-gray-600 flex items-center gap-1 transition"
                                            >
                                                <Icons.Download /> Export TXT
                                            </button>
                                            <button 
                                                onClick={handleClearChat} 
                                                className="text-xs px-3 py-1 rounded-lg bg-red-700 hover:bg-red-600 flex items-center gap-1 transition"
                                            >
                                                <Icons.Trash /> Clear Chat
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'dashboard' && (
                                <div className="p-6 space-y-6">
                                    <h2 className="text-3xl font-bold mb-6">Analytics Dashboard</h2>

                                    {analyticsLoading ? (
                                        <div className="flex justify-center items-center h-64">
                                            <Icons.Loader2 />
                                            <span className="ml-2">Loading analytics...</span>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                                <StatCard icon={Icons.Brain} title="Model Accuracy" value={`${analytics.accuracy.toFixed(1)}%`} trend="+2.3%" color="bg-blue-500" darkMode={darkMode} />
                                                <StatCard icon={Icons.Clock} title="Avg Latency" value={`${Math.round(analytics.avg_latency)}ms`} trend="-12ms" color="bg-purple-500" darkMode={darkMode} />
                                                <StatCard icon={Icons.Activity} title="Total Queries" value={analytics.total_queries} trend="+156" color="bg-green-500" darkMode={darkMode} />
                                                <StatCard icon={Icons.Zap} title="Active Users" value={analytics.active_users} trend="+5" color="bg-orange-500" darkMode={darkMode} />
                                            </div>

                                            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur-sm border rounded-2xl p-6`}>
                                                <p className="text-center text-gray-400">
                                                    üìä Real-time charts available when backend analytics are fully configured
                                                </p>
                                            </div>
                                        </>
                                    )}
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="p-6 max-w-4xl mx-auto space-y-6">
                                    <h2 className="text-3xl font-bold mb-6">Settings</h2>
                                    
                                    <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur-sm border rounded-2xl p-6 space-y-6`}>
                                        <div>
                                            <h3 className="text-lg font-semibold mb-4">Backend Configuration</h3>
                                            <p className="text-sm text-gray-400 mb-4">
                                                Backend URL: <code className="bg-gray-900 px-2 py-1 rounded">{API_BASE_URL}</code>
                                            </p>
                                            <p className="text-sm mb-4">
                                                Status: <span className={`font-semibold ${connectionStatus === 'connected' ? 'text-green-500' : 'text-red-500'}`}>
                                                    {connectionStatus === 'connected' ? '‚úÖ Connected' : '‚ùå Disconnected'}
                                                </span>
                                            </p>
                                            <div className="space-y-2 text-sm">
                                                <p>‚úÖ Chat endpoint: <code className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} px-2 py-1 rounded`}>/api/chat</code></p>
                                                <p>‚úÖ Streaming: <code className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} px-2 py-1 rounded`}>/api/chat/stream</code></p>
                                                <p>‚úÖ Analytics: <code className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} px-2 py-1 rounded`}>/api/analytics</code></p>
                                                <p>‚úÖ Export: <code className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} px-2 py-1 rounded`}>/api/conversations/export</code></p>
                                            </div>
                                        </div>

                                        <div>
                                            <h3 className="text-lg font-semibold mb-4">Quick Start</h3>
                                            <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} p-4 rounded-lg text-sm font-mono space-y-2`}>
                                                <p className="text-gray-400"># Terminal 1: Start Backend</p>
                                                <p className="text-green-400">cd backend && python backend_api.py</p>
                                                <p className="text-gray-400 mt-4"># Terminal 2: Open Frontend</p>
                                                <p className="text-blue-400">Open index.html in browser</p>
                                            </div>
                                        </div>

                                        <div>
                                            <h3 className="text-lg font-semibold mb-4">Features</h3>
                                            <ul className="space-y-2 text-sm">
                                                <li>‚úÖ Real-time streaming chat</li>
                                                <li>‚úÖ Source citations from medical knowledge base</li>
                                                <li>‚úÖ Dark/Light mode toggle</li>
                                                <li>‚úÖ Export conversations (JSON/TXT)</li>
                                                <li>‚úÖ Analytics dashboard with live metrics</li>
                                                <li>‚úÖ Responsive design for all devices</li>
                                                <li>‚úÖ Session persistence (localStorage)</li>
                                                <li>‚úÖ Connection status monitoring</li>
                                                <li>‚úÖ Error boundary for crash recovery</li>
                                            </ul>
                                        </div>

                                        <div>
                                            <h3 className="text-lg font-semibold mb-4">Session Info</h3>
                                            <p className="text-sm">
                                                Session ID: <code className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} px-2 py-1 rounded`}>
                                                    {api.sessionId || 'Not started'}
                                                </code>
                                            </p>
                                            <p className="text-sm mt-2">
                                                Messages in history: <span className="font-semibold">{messages.length}</span>
                                            </p>
                                        </div>

                                        <div>
                                            <h3 className="text-lg font-semibold mb-4">Medical Disclaimer</h3>
                                            <p className="text-sm text-gray-400">
                                                ‚ö†Ô∏è This tool provides general medical information only and is NOT a substitute for professional medical advice, 
                                                diagnosis, or treatment. Always consult with a qualified healthcare provider for medical concerns.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        // =====================================================================
        // RENDER APP
        // =====================================================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <HaleAIApp />
            </ErrorBoundary>
        );
    </script>
</body>
</html>